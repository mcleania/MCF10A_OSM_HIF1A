---
title: "MCF10A_MolecularData"
author: "IM"
date: "2023-06-24"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#load libraries
library(readr)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(ggpmisc)
library(lsmeans)
library(ComplexHeatmap)
library(circlize)

#set ligand graphical parameters
my_cols <- c('EGF'='#F68282',
             'IFNG'='#CCB1F1',
             'OSM'='#E6C122'
             )
```


```{r data, echo=FALSE}
#read in integrated molecular data collected from MCF10A cells treated with microenvironmental ligands (https://www.synapse.org/Synapse:syn26523857) 
molecular_dat<-read_csv('Data/MDD_multiomics_matrix.csv')

#format integrated molecular data
molecular_dat_format<-molecular_dat %>%
  gather(key = experimentalCondition, value=log2FoldChange, -Type, -feature)

#read in rppa data (https://www.synapse.org/Synapse:syn12628291)
rppa_symbols<-read_csv('Data/MDD_RPPA_antibodyAnnotations.csv')
rppa_lvl3<-read_csv('Data/MDD_RPPA_Level3.csv')
annot<-read_csv('Data/MDD_sample_annotations.csv')

#add sample metadata and format rppa data
rppa<-rppa_lvl3 %>%
 column_to_rownames('antibody') %>%
  t %>%
  as.data.frame() %>%
  rownames_to_column('specimenID') %>%
  full_join(annot) %>%
  filter(RPPA_QCpass==TRUE) %>%
  filter(ligand=='OSM' | ligand == 'EGF' | ligand == 'IFNG' | ligand == 'ctrl') 

symbols_from<-rppa_symbols %>%
  select(MDD, Symbols) %>%
  rename(ID=MDD) 

#import RNAseq data (https://www.synapse.org/Synapse:syn18485473, https://www.synapse.org/Synapse:syn18779231)
rna_lvl4<-read_csv('Data/MDD_RNAseq_Level4.csv')
rna_lvl3<-read_csv('Data/MDD_RNAseq_Level3.csv')
gene_md<-read_csv('Data/MDD_RNAseq_geneAnnotations.csv')

#format RNAseq data
RNAseq_md<-full_join(gene_md,rna_lvl3) %>%
  select(-ensembl_gene_id) %>%
  filter(hgnc_symbol == 'HIF1A') %>%
  column_to_rownames('hgnc_symbol') %>%
  t %>%
  as.data.frame() %>%
  rownames_to_column('specimenID')

RNAseq_md4<-full_join(gene_md,rna_lvl4) %>%
  rename(name = hgnc_symbol)

#format sample IDs
sid_meta_format<-annot %>%
  filter(RNAseq_QCpass=='TRUE') %>%
  select(specimenID, experimentalCondition, ligand, experimentalTimePoint)

#combine RNAseq with sample info
rna_dat_imp<-left_join(sid_meta_format,RNAseq_md) %>%
  group_by(ligand, experimentalTimePoint, experimentalCondition) %>%
  summarize_if(is.numeric,mean)

```

```{r RPPA and RNAseq lineplots for specific features, echo=FALSE}
#visualize lineplots of select RPPA and RNAseq features

#T0 normalized lineplot for RPPA data
t0_lineplot<-function(data=rppa, feature=quo(Snail)){
  #normalize to T0
  t0_val<-data %>%
    select(ligand, experimentalTimePoint, !!feature, replicate) %>%
    filter(experimentalTimePoint == 0) %>% 
    mutate(feature_ctrl = !!feature) %>%
    select(feature_ctrl, replicate)
  
  dt_T0 <- data %>%
    select(ligand, experimentalTimePoint, !!feature, replicate) %>%
    left_join(t0_val) %>%
    mutate(feature_normed=(!!feature+1)/(feature_ctrl+1)) %>%
    filter(experimentalTimePoint!=0) %>%
    group_by(ligand, experimentalTimePoint) %>%
    mutate(feature_median = median(feature_normed)) %>%
    mutate(feature_min = min(feature_normed)) %>%
    mutate(feature_max = max(feature_normed)) %>%
    ungroup()
  
  #add time0 for each ligand (ctrl condition)
  addendum<-dt_T0[1:3,] %>%
    mutate(ligand = c('EGF','OSM','IFNG')) %>%
    mutate(experimentalTimePoint=0) %>%
    mutate(feature_median=1, feature_max=1, feature_min=1) 
  
  #bind to dataframe
  df <- dt_T0 %>%
    rbind(addendum) 
  
  #plot lineplots
  ggplot(df, aes(x=as.numeric(experimentalTimePoint), y = feature_median, group = ligand, color = ligand)) +
    geom_line(linewidth=2) + geom_point(aes(x=as.numeric(experimentalTimePoint), y=feature_normed)) +       geom_errorbar(aes(ymin = feature_min, ymax = feature_max), size = 1, width = 1) +
    scale_x_continuous(breaks = c(0,1,4,8,24,48)) + scale_color_manual(values = my_cols) + expand_limits(x=57) +
    labs(x="Time (hrs)",
       y=as.character(feature)
    ) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 0, size=rel(3)),
         axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(3)),
         plot.title = element_text(size = rel(3)),legend.text=element_text(size = rel(1)), axis.title = element_text(size = rel(3)),
          legend.title=element_text(size = rel(2)),  panel.grid.minor = element_blank())+                                                               # Change font size
    theme(strip.text.x = element_text(size = 25))  + guides(color=guide_legend(title="Ligand")) 
}

#HIF1A RNAseq lineplot
RNAseq_hif1a<-rna_dat_imp %>%
  filter(ligand == 'EGF' | ligand == 'OSM' | ligand == 'IFNG' | ligand == 'ctrl')

#t0 readiing
time0_col<-RNAseq_hif1a %>% filter(experimentalTimePoint==0) 
time0_col1<-rbind(time0_col, time0_col) %>%
  rbind(time0_col) %>%
  mutate(ligand = c('EGF','IFNG','OSM'))

RNAseq_hif1a<-RNAseq_hif1a %>%
  filter(experimentalTimePoint>0) %>%
  rbind(time0_col1)

ggplot(RNAseq_hif1a, aes(x=experimentalTimePoint, y = HIF1A, group = ligand, color = ligand, fill = ligand)) +
  geom_line(size=2) + scale_color_manual(values=my_cols) +
  scale_x_continuous(breaks = c(0,24,48)) +
  labs(x="Time (hrs)",
       y="HIF1A FPKM"
  )  +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0, size=rel(3)),
        axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(3)),
        plot.title = element_text(size = rel(3)),legend.text=element_text(size = rel(2)), axis.title = element_text(size = rel(3)),
        legend.title=element_text(size = rel(2)))+ guides(color=guide_legend(title="Ligand"))
```

```{r CausalPath Input, echo=FALSE}
#prepare integrated matrix for input into Causal path
#filter for features upregulated by OSM or IFNG LFC > 1
rppa_osm_pos<-molecular_dat_format %>%
  filter(Type=='RPPA') %>%
  filter(experimentalCondition=='OSM_48') %>%
  select(-Type) %>%
  filter(log2FoldChange > 1 ) %>%
  rename(ID=feature, Value=log2FoldChange) %>%
  left_join(symbols_from) 

#OSM upregulated cycIF intensiity features
cyc_osm_pos<-molecular_dat_format %>%
  filter(Type=='cycIF') %>%
  filter(experimentalCondition=='OSM_48') %>%
  filter((log2FoldChange>1 )) %>%
  filter(grepl('int_mean', feature)) %>%
  select(-Type) %>%
  rename(ID=feature, Value=log2FoldChange) %>%
  mutate(Symbols = '')

cyc_osm_pos$Symbols<-c('NDRG1', '', '')
cyc_osm_pos<-cyc_osm_pos %>%
  filter(Symbols !='') %>%
  #filter out features shared wiith RPPA
  filter(Symbols %notin% rppa_osm_pos$Symbols)

#RNAseq upregulated features
rna_osm_pos<-molecular_dat_format %>%
  filter(Type=='RNAseq') %>%
  filter(experimentalCondition=='OSM_48') %>%
  filter((log2FoldChange>1 )) %>%
  rename(ID=feature, Value=log2FoldChange) %>%
  select(-Type)

rna_osm_pos$Symbols <-rna_osm_pos$ID

#filter out features shared with RPPA or cycif
rna_osm_filt_pos<-rna_osm_pos %>%
  filter(Symbols %notin% rppa_osm_pos$Symbols & Symbols %notin% cyc_osm_pos$Symbols)

osm_all_out_pathway_commons_pos<-rbind( rppa_osm_pos, rna_osm_filt_pos, cyc_osm_pos)

osm_all_out_pathway_commons_pos$Sites<-''
osm_all_out_pathway_commons_pos$ligand = 'OSM'

write_csv(osm_all_out_pathway_commons_pos, 'OSM_CausalPath_Data.csv')

#IFNG upregulated RPPA features
rppa_ifng_pos<-molecular_dat_format %>%
  filter(Type=='RPPA') %>%
  filter(experimentalCondition=='IFNG_48') %>%
  select(-Type) %>%
  filter(log2FoldChange > 1 ) %>%
  rename(ID=feature, Value=log2FoldChange) %>%
  #add hgnc_symbols
  left_join(symbols_from) 

#ifng upregulated cycIF intensiity features
cyc_ifng_pos<-molecular_dat_format %>%
  filter(Type=='cycIF') %>%
  filter(experimentalCondition=='IFNG_48') %>%
  filter((log2FoldChange>1 )) %>%
  filter(grepl('int_mean', feature)) %>%
  select(-Type) %>%
  rename(ID=feature, Value=log2FoldChange) %>%
  mutate(Symbols = '')

#manually add hgnc_symbols
cyc_ifng_pos$Symbols<-c('KRT18', '', 'MKI67', 'MET', 'NFKB1', 'CDKN1A', 'CD274', '', 'RPS6', '', 'STAT1',
                        '','','','STAT3', 'VIM')

cyc_ifng_pos<-cyc_ifng_pos %>%
  filter(Symbols !='') %>%
  #filter out features shared wiith RPPA
  filter(Symbols %notin% rppa_ifng_pos$Symbols)

#RNAseq upregulated features
rna_ifng_pos<-molecular_dat_format %>%
  filter(Type=='RNAseq') %>%
  filter(experimentalCondition=='IFNG_48') %>%
  filter((log2FoldChange>1 )) %>%
  rename(ID=feature, Value=log2FoldChange) %>%
  select(-Type)

rna_ifng_pos$Symbols <-rna_ifng_pos$ID

#filter out features shared with RPPA or cycif
rna_ifng_filt_pos<-rna_ifng_pos %>%
  filter(Symbols %notin% rppa_ifng_pos$Symbols & Symbols %notin% cyc_ifng_pos$Symbols)

ifng_all_out_pathway_commons_pos<-rbind( rppa_ifng_pos, rna_ifng_filt_pos, cyc_ifng_pos)

ifng_all_out_pathway_commons_pos$Sites<-''
ifng_all_out_pathway_commons_pos$ligand = 'IFNG'

write_csv(ifng_all_out_pathway_commons_pos, 'IFNG_CausalPath_Data.csv')
```

```{r Heatmap, echo=FALSE}
#heatmap of IFNG and OSM upregulated features
#bind OSM and IFNG data
osm_ifng_list<-rbind(osm_all_out_pathway_commons_pos, ifng_all_out_pathway_commons_pos) %>%
  select(ID, ligand, Value, Symbols) %>%
  spread(key = ligand, value = Value) %>%
  rename(feature = ID)

#format integrated LFC data from upregulated features
osm_ifng_hm <-molecular_dat_format %>%
  filter(experimentalCondition=='OSM_24' | experimentalCondition == 'OSM_48'| experimentalCondition=='IFNG_24' | experimentalCondition == 'IFNG_48')%>%
  filter(feature %in% osm_ifng_list$feature) %>%
  left_join(osm_ifng_list) %>%
  select(Symbols, experimentalCondition, log2FoldChange, Type) 

osm_ifng_hm  <- osm_ifng_hm %>%
  group_by(experimentalCondition, Symbols) %>%
  mutate(log2FoldChange = max(log2FoldChange))%>%
  select(-Type) %>%
  distinct()

osm_ifng_hm<-osm_ifng_hm %>%
  spread(key = experimentalCondition, value = log2FoldChange) %>%
  drop_na() %>%
  column_to_rownames('Symbols')

colnames(osm_ifng_hm)<-c('IFNG - 24', 'IFNG - 48', 'OSM - 24', 'OSM - 48')  

#draw heatmap         
Heatmap(matrix = osm_ifng_hm,
        name = "LFC",
        column_title = 'Integrated Molecular Matrix',
        show_row_names = F,
        show_column_names = T,
        cluster_columns = F,
        cluster_rows = T,
        na_col = "grey",
        row_title_gp = gpar(fontsize = 26),
        col=colorRamp2(c(-3, 0, 3), c("blue", "white", "red")),
        heatmap_legend_param = list(labels_gp = gpar( fontsize = 26), title_gp = gpar( fontsize = 26)),
        column_title_gp = gpar(fontsize = 30),
        column_names_gp = gpar(fontsize = 24))
```

```{r Node rewiring rankings, echo=FALSE}
#rank all nodes from cytoscape analysis for rewiring when comparing OSM vs IFNG
#import infg vs osm nodes with rewiring scores and define ranking for expression for tfs and genes, data is available on github
osm_ifng_node_rewiring<-read_csv('Data/OSM_rewiring_scores.csv')

#filter for OSM nodes
osm_present<-osm_ifng_node_rewiring %>%
  filter(osm_pos.sif_present=='TRUE')

osm_present_genes <- osm_present %>%
  left_join(RNAseq_md4) %>%
  #scale by expression by OSM at 48 hours
  mutate(expression_z = scale(OSM_48, center = F)) %>%
  #scale rewiring score 
  mutate(dyn_z = scale(`DyNet Rewiring (Dn-score)`, center = F)) %>%
  #define comparative network importance score
  mutate(z_ranking = dyn_z + expression_z)
osm_present_genes<-osm_present_genes[order(osm_present_genes$z_ranking, decreasing = T),]

#plot top 14
t<-ggplot(osm_present_genes[c(1:14),], aes(x = reorder(name, z_ranking), y=z_ranking)) +
  geom_bar(stat='identity') + coord_flip() +
  theme() + xlab('Node')  + ylab('Comparative Network Importance Score') +
  theme_bw() + theme(axis.title.x = element_text(size = 24),
                     axis.text.x = element_text(size = 24),
                     axis.title.y = element_text(size = 24),
                     axis.text.y = element_text(size = 28),panel.border = element_blank(), 
                                                          axis.line = element_blank())
```



